name: Auto Patch from Issue

on:
  issues:
    types: [opened]

jobs:
  auto-patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install openai pytest

      - name: Set environment variables
        run: |
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "ISSUE_BODY=${{ github.event.issue.body }}" >> $GITHUB_ENV

      - name: Generate patch using LLM
        run: python generate_patch.py
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Apply patch
        run: cp patch.py src/module_to_patch.py

      - name: Run tests
        run: pytest tests/ --maxfail=1 --disable-warnings -q
