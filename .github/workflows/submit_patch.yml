name: ğŸ¤– Agent Submit Issue

on:
  issues:
    types: [labeled]

jobs:
  patch-generation:
    if: github.event.label.name == 'agent:submit'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ›ï¸ Check out repository
        uses: actions/checkout@v4

      - name: ğŸŒ¿ Create new branch
        run: |
          BRANCH="patch-agent-fix"
          git checkout -b $BRANCH
          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV

      - name: ğŸ“Œ Apply patch
        run: |
          git apply .agent/changes.patch
          git add .
          git commit -m "Apply auto-generated patch"

      - name: ğŸš¢ Push branch
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Set the remote with token to avoid 403
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          git push origin "${BRANCH_NAME}"

      - name: ğŸ” Open Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "Automated Patch Submission"
          body: "This PR applies the generated patch."
          labels: "automated, patch"
